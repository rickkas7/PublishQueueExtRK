<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PublishQueueExtRK: PublishQueueExt</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">PublishQueueExtRK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title"><a class="el" href="class_publish_queue_ext.html" title="Class for asynchronous publishing of events.">PublishQueueExt</a> </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__r_e_a_d_m_e"></a> Queued publish for Particle devices using typed and extended publish</p>
<p>This is version of <a href="https://github.com/rickkas7/PublishQueuePosixRK">PublishQueuePosixRK</a> that is designed for use with <a href="https://docs.particle.io/reference/device-os/typed-publish/">typed and extended publish</a> in Device OS 6.3.0 and later.</p>
<p>This library can only be used on newer versions of Device OS, but offers several benefits:</p>
<ul>
<li>Increased rate limit, no longer limited to 1 publish per second</li>
<li>Increased event data size, up to 16384 bytes</li>
<li>Binary values in event data</li>
</ul>
<h1>Usage</h1>
<p>In many cases, you simply call this from setup:</p>
<div class="fragment"><div class="line"><a class="code hl_function" href="class_publish_queue_ext.html#a7be22f9aadeb823f0e245d341ac89622">PublishQueueExt::instance</a>().<a class="code hl_function" href="class_publish_queue_ext.html#aff151cce8ada685b1e2d34e24d83906b">setup</a>();</div>
<div class="ttc" id="aclass_publish_queue_ext_html_a7be22f9aadeb823f0e245d341ac89622"><div class="ttname"><a href="class_publish_queue_ext.html#a7be22f9aadeb823f0e245d341ac89622">PublishQueueExt::instance</a></div><div class="ttdeci">static PublishQueueExt &amp; instance()</div><div class="ttdoc">Gets the singleton instance of this class.</div><div class="ttdef"><b>Definition</b> PublishQueueExtRK.cpp:13</div></div>
<div class="ttc" id="aclass_publish_queue_ext_html_aff151cce8ada685b1e2d34e24d83906b"><div class="ttname"><a href="class_publish_queue_ext.html#aff151cce8ada685b1e2d34e24d83906b">PublishQueueExt::setup</a></div><div class="ttdeci">void setup()</div><div class="ttdoc">You must call this from setup() to initialize this library.</div><div class="ttdef"><b>Definition</b> PublishQueueExtRK.cpp:30</div></div>
</div><!-- fragment --><p>And this from loop:</p>
<div class="fragment"><div class="line"><a class="code hl_function" href="class_publish_queue_ext.html#a7be22f9aadeb823f0e245d341ac89622">PublishQueueExt::instance</a>().<a class="code hl_function" href="class_publish_queue_ext.html#aff151cce8ada685b1e2d34e24d83906b">setup</a>();</div>
</div><!-- fragment --><p>To publish you do something like this:</p>
<div class="fragment"><div class="line">PublishQueueExt::instance().publish(&quot;testEvent&quot;, buf, PRIVATE | WITH_ACK);</div>
</div><!-- fragment --><h2>File queue</h2>
<p>The default maximum file queue size is 100, which corresponds to 100 events. Each event takes is stored in a single file. In many cases, an event will fit in a single 512-byte flash sector, but it could require two, or three, for a full 1024 byte event with the overhead. A full 16384 byte event could take 33 sectors.</p>
<div class="fragment"><div class="line"><a class="code hl_function" href="class_publish_queue_ext.html#a7be22f9aadeb823f0e245d341ac89622">PublishQueueExt::instance</a>().<a class="code hl_function" href="class_publish_queue_ext.html#a45c6e19557266a4a33ab51ad5d2a80d0">withFileQueueSize</a>(50);</div>
<div class="ttc" id="aclass_publish_queue_ext_html_a45c6e19557266a4a33ab51ad5d2a80d0"><div class="ttname"><a href="class_publish_queue_ext.html#a45c6e19557266a4a33ab51ad5d2a80d0">PublishQueueExt::withFileQueueSize</a></div><div class="ttdeci">PublishQueueExt &amp; withFileQueueSize(size_t size)</div><div class="ttdoc">Sets the file-based queue size (default is 100)</div><div class="ttdef"><b>Definition</b> PublishQueueExtRK.cpp:20</div></div>
</div><!-- fragment --><h1>Dependencies</h1>
<p>This library depends on two additional libraries:</p>
<ul>
<li><a href="https://github.com/rickkas7/SequentialFileRK">SequentialFileRK</a> manages the queue on the flash file system</li>
</ul>
<h1>API</h1>
<hr  />
<h2>void <a class="el" href="class_publish_queue_ext.html#aff151cce8ada685b1e2d34e24d83906b" title="You must call this from setup() to initialize this library.">PublishQueueExt::setup()</a></h2>
<p>You must call this from setup() to initialize this library.</p>
<div class="fragment"><div class="line">void setup()</div>
</div><!-- fragment --><hr  />
<h2>void <a class="el" href="class_publish_queue_ext.html#ac9d667b2ddc76f506ba6db84003dbc7a" title="You must call the loop method from the global loop() function!">PublishQueueExt::loop()</a></h2>
<p>You must call the loop method from the global loop() function!</p>
<div class="fragment"><div class="line">void loop()</div>
</div><!-- fragment --> <hr  />
<h2><a class="el" href="class_publish_queue_ext.html" title="Class for asynchronous publishing of events.">PublishQueueExt</a> &amp; <a class="el" href="class_publish_queue_ext.html#a45c6e19557266a4a33ab51ad5d2a80d0" title="Sets the file-based queue size (default is 100)">PublishQueueExt::withFileQueueSize(size_t size)</a></h2>
<p>Sets the file-based queue size (default is 100)</p>
<div class="fragment"><div class="line">PublishQueueExt &amp; withFileQueueSize(size_t size)</div>
</div><!-- fragment --><h3>Parameters</h3>
<ul>
<li><code>size</code> The maximum number of files to store (one event per file)</li>
</ul>
<p>If you exceed this number of events, the oldest event is discarded.</p>
<hr  />
<h2>size_t <a class="el" href="class_publish_queue_ext.html#afb48a78373bf334d74df86e286c23f0d" title="Gets the file queue size.">PublishQueueExt::getFileQueueSize() const</a></h2>
<p>Gets the file queue size.</p>
<div class="fragment"><div class="line">size_t getFileQueueSize() const</div>
</div><!-- fragment --><hr  />
<h2><a class="el" href="class_publish_queue_ext.html" title="Class for asynchronous publishing of events.">PublishQueueExt</a> &amp; <a class="el" href="class_publish_queue_ext.html#a5fd49955e24427561875e23305a6aa9c" title="Sets the directory to use as the queue directory. This is required!">PublishQueueExt::withDirPath(const char * dirPath)</a></h2>
<p>Sets the directory to use as the queue directory. This is required!</p>
<div class="fragment"><div class="line">PublishQueueExt &amp; withDirPath(const char * dirPath)</div>
</div><!-- fragment --><h3>Parameters</h3>
<ul>
<li><code>dirPath</code> the pathname, Unix-style with / as the directory separator.</li>
</ul>
<p>Typically you create your queue either at the top level ("/myqueue") or in /usr ("/usr/myqueue"). The directory will be created if necessary, however only one level of directory will be created. The parent must already exist.</p>
<p>The dirPath can end with a slash or not, but if you include it, it will be removed.</p>
<p>You must call this as you cannot use the root directory as a queue!</p>
<hr  />
<h2>const char * <a class="el" href="class_publish_queue_ext.html#af469e16e7fdd0d552b944d2418aedead" title="Gets the directory path set using withDirPath()">PublishQueueExt::getDirPath() const</a></h2>
<p>Gets the directory path set using withDirPath()</p>
<div class="fragment"><div class="line">const char * getDirPath() const</div>
</div><!-- fragment --><p>The returned path will not end with a slash.</p>
<hr  />
<h2>bool <a class="el" href="class_publish_queue_ext.html#aff3b51718306124c20d8ad186f5538eb" title="Publish an event.">PublishQueueExt::publish(CloudEvent event)</a></h2>
<p>This is the recommended version to use, which takes a <code>CloudEvent</code> that includes the event name and can include typed data, binary data, or structured data.</p>
<div class="fragment"><div class="line">bool publish(CloudEvent event);</div>
</div><!-- fragment --><hr  />
<h2>bool <a class="el" href="class_publish_queue_ext.html#ade52d7bc6df525c3fbf576740d6b92e2" title="Overload for publishing an event with a Variant and ContentType.">PublishQueueExt::publish(const char * eventName, const Variant &amp;data, ContentType type)</a></h2>
<p>You can also <code>Variant</code> that can include typed data, binary data, or structured data.</p>
<div class="fragment"><div class="line">bool publish(const char *eventName, const Variant &amp;data);</div>
</div><!-- fragment --><h3>Parameters</h3>
<ul>
<li><code>eventName</code> The name of the event (63 character maximum).</li>
<li><code>data</code> The event data as a <code>Variant</code> object reference.</li>
<li><code>type</code> The <code>ContentType</code> of the data</li>
</ul>
<p>The data is written to a file on the file system before this call returns.</p>
<p>Content Type Constant MIME Type Value ContentType::TEXT text/plain; charset=utf-8 0 ContentType::JPEG image/jpeg 22 ContentType::PNG image/png 23 ContentType::BINARY application/octet-stream 42 ContentType::STRUCTURED 65001</p>
<h2>bool <a class="el" href="class_publish_queue_ext.html#a9030cdc4d59259aa514056534f546d43" title="Overload for publishing an event from a Variant.">PublishQueueExt::publish(const char * eventName, const Variant &amp;data)</a></h2>
<p>This overload takes a <code>Variant</code> but not a <code>ContentType</code>. It should only be used when passing a <code>VariantMap</code> for structured data.</p>
<div class="fragment"><div class="line">bool publish(const char *eventName, const Variant &amp;data);</div>
</div><!-- fragment --><h3>Parameters</h3>
<ul>
<li><code>eventName</code> The name of the event (63 character maximum).</li>
<li><code>data</code> The event data as a <code>Variant</code> object reference.</li>
</ul>
<p>The data is written to a file on the file system before this call returns.</p>
<hr  />
<h2>bool <a class="el" href="class_publish_queue_ext.html#a3612467432edb9b35532f316cc604dde" title="Overload for publishing an event.">PublishQueueExt::publish(const char * eventName)</a></h2>
<p>Overload for publishing an event.</p>
<div class="fragment"><div class="line">bool publish(const char * eventName)</div>
</div><!-- fragment --><h3>Parameters</h3>
<ul>
<li><code>eventName</code> The name of the event (63 character maximum).</li>
</ul>
<h3>Returns</h3>
<p>true if the event was queued or false if it was not.</p>
<p>This function almost always returns true. If you queue more events than fit in the buffer the oldest (sometimes second oldest) is discarded.</p>
<hr  />
<h2>bool <a class="el" href="class_publish_queue_ext.html#a40539be5431fb4797dba65eddfbc73e2" title="Overload for publishing an event.">PublishQueueExt::publish(const char * eventName, const char * data)</a></h2>
<p>Overload for publishing an event.</p>
<div class="fragment"><div class="line">bool publish(const char * eventName, const char * data, PublishFlags flags1, PublishFlags flags2)</div>
</div><!-- fragment --><h3>Parameters</h3>
<ul>
<li><code>eventName</code> The name of the event (63 character maximum).</li>
<li><code>data</code> The event data (255 bytes maximum, 622 bytes in system firmware 0.8.0-rc.4 and later).</li>
</ul>
<h3>Returns</h3>
<p>true if the event was queued or false if it was not.</p>
<p>This function almost always returns true. If you queue more events than fit in the buffer the oldest (sometimes second oldest) is discarded.</p>
<hr  />
<h2>void <a class="el" href="class_publish_queue_ext.html#ac2a85caba851883ad131fe577ddd6acc" title="Empty the file based queue. Any queued events are discarded and the files deleted.">PublishQueueExt::clearQueues()</a></h2>
<p>Empty both the RAM and file based queues. Any queued events are discarded.</p>
<div class="fragment"><div class="line">void clearQueues()</div>
</div><!-- fragment --><hr  />
<h2>void <a class="el" href="class_publish_queue_ext.html#abc5477889eea9b5555a70e9ad19dc000" title="Pause or resume publishing events.">PublishQueueExt::setPausePublishing(bool value)</a></h2>
<p>Pause or resume publishing events.</p>
<div class="fragment"><div class="line">void setPausePublishing(bool value)</div>
</div><!-- fragment --><h3>Parameters</h3>
<ul>
<li><code>value</code> The value to set, true = pause, false = normal operation</li>
</ul>
<p>If called while a publish is in progress, that publish will still proceed, but the next event (if any) will not be attempted.</p>
<p>This is used by the automated test tool; you probably won't need to manually manage this under normal circumstances.</p>
<hr  />
<h2>bool <a class="el" href="class_publish_queue_ext.html#a3cd00397946c222241a507dde4fadda6" title="Gets the state of the pause publishing flag.">PublishQueueExt::getPausePublishing() const</a></h2>
<p>Gets the state of the pause publishing flag.</p>
<div class="fragment"><div class="line">bool getPausePublishing() const</div>
</div><!-- fragment --> <hr  />
<h2>bool <a class="el" href="class_publish_queue_ext.html#a41d836715f52f69367b2fbc32ac7f626" title="Determine if it&#39;s a good time to go to sleep.">PublishQueueExt::getCanSleep() const</a></h2>
<p>Determine if it's a good time to go to sleep. Added in version 0.0.3.</p>
<div class="fragment"><div class="line">bool getCanSleep() const</div>
</div><!-- fragment --><p>If a publish is not in progress and the queue is empty, returns true.</p>
<p>If pausePublishing is true, then return true if either the current publish has completed, or not cloud connected.</p>
<hr  />
<h2>size_t <a class="el" href="class_publish_queue_ext.html#a45e82c9642ecfa120db037c0ecb559d8" title="Gets the total number of events queued.">PublishQueueExt::getNumEvents()</a></h2>
<p>Gets the total number of events queued.</p>
<div class="fragment"><div class="line">size_t getNumEvents()</div>
</div><!-- fragment --><p>This is the number of events in the RAM-based queue and the file-based queue. This operation is fast; the file queue length is stored in RAM, so this command does not need to access the file system.</p>
<p>If an event is currently being sent, the result includes this event.</p>
<hr  />
<h2>void <a class="el" href="class_publish_queue_ext.html#aea0c23106d679ecf42a5c4a055b8e8b3" title="Lock the queue protection mutex.">PublishQueueExt::lock()</a></h2>
<p>Lock the queue protection mutex.</p>
<div class="fragment"><div class="line">void lock()</div>
</div><!-- fragment --><p>This is done internally; you probably won't need to call this yourself. It needs to be public for the WITH_LOCK() macro to work properly.</p>
<hr  />
<h2>bool <a class="el" href="class_publish_queue_ext.html#a3ead0b1e95e512a3cdaf9a7f364e0a34" title="Attempt the queue protection mutex.">PublishQueueExt::tryLock()</a></h2>
<p>Attempt the queue protection mutex.</p>
<div class="fragment"><div class="line">bool tryLock()</div>
</div><!-- fragment --><hr  />
<h2>void <a class="el" href="class_publish_queue_ext.html#a92c241c63e7d05fe1d4d189521b53c89" title="Unlock the queue protection mutex.">PublishQueueExt::unlock()</a></h2>
<p>Unlock the queue protection mutex.</p>
<div class="fragment"><div class="line">void unlock()</div>
</div><!-- fragment --><h1>Version History</h1>
<h2>0.0.1 (2025-02-19)</h2>
<ul>
<li>Initial version </li>
</ul>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"/>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0
</small></address>
</body>
</html>
